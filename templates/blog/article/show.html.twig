{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} | {{ title }}{% endblock %}

{% block body %}

    {% set user = article.author %}
    <section id="showArticle">
        {{include('partials/_navbarMenu.html.twig')}}
    
        <div class="container-fluid wrapper">
            <div class="row col-xs-12 col-md-10" id="wrapArticleContent">
                    <h2>{{article.title}}</h2>  
                <div class="col-md-8">
                {# on verifie si il y a des images et/ou des videos pour les affichages des onglets #}
                {% if article.video or article.images is not empty %}
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        {% if article.video %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#videoTab" type="button" role="tab" aria-controls="video-tab" aria-selected="true"><i class="fa-solid fa-film"></i> Vidéo</button>
                        </li>
                        {% endif %}
                        {% if article.images is not empty %}
                        <li class="nav-item" role="presentation">
                            <button {% if article.video %} class="nav-link" {% else %} class="nav-link active" {% endif %} id="profile-tab" data-bs-toggle="tab" data-bs-target="#imagesTab" type="button" role="tab" aria-controls="images-tab" aria-selected="false"><i class="fa-sharp fa-solid fa-images"></i> Images</button>
                        </li>
                        {% endif %}
                    </ul>
                {% endif %}
                        
                        <div class="tab-content" id="articleTabs">
                            {# onglet video si il y en a #}
                            {% if article.video %}
                            <div class="tab-pane fade show active" id="videoTab" role="tabpanel" aria-labelledby="video-tab">
                                <div class="col-md-12">
                                    {# video affichée #}
                                    {% include "/partials/_video.html.twig" %} 
                                </div>
                            </div>
                            {% endif %}

                             {# onglet carousel images si il y en a #}
                            {% if article.images is not empty %}

                            <div {% if not article.video %} class="tab-pane fade show active" {% else %} class="tab-pane fade show" {% endif %} id="imagesTab" role="tabpanel" aria-labelledby="images-tab">
                                <div id="carouselImages" class="carousel slide " data-bs-ride="true">
                                    <div class="carousel-indicators">
                                        {% for image in article.images %}
                                        <button type="button" data-bs-target="#carouselImages" data-bs-slide-to="{{ loop.index0 }}" {% if loop.index0 == 0 %} class="active" {% endif %} aria-current="true" aria-label="Slide {{loop.index}}"></button>
                                        {% endfor %}
                                    </div>
                                    <div class="carousel-inner ratio ratio-16x9">
                                        {% for image in article.images %}
                                        <div  {% if loop.index0 == 0 %} class="carousel-item active"  {% else %} class="carousel-item" {% endif %} >
                                            <img src="{{asset('/uploads/article/image/'~ image.source)}}" alt="Image d'illustration de l'article {{article.title}}" >
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselImages" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Précédent</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carouselImages" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Suivant</span>
                                    </button>
                                </div>
                            
                            </div>
                            {% endif %}
                        </div>
                       
                    <div class="row">
                    {# si il n'y a ni video, ni images : image par defaut #}
                    {% if not article.video and article.images is empty %}
                        <div>
                            <img class="figure-img rounded img-fluid" src="{{asset('/img/blogDefault.png')}}" alt="Image d'illustration par défaut" > 
                        </div>    
                    {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center px-1">
                        <div class="user">
                            <div class="avatar">
                                    <img src="{{asset('/uploads/avatar/'~ user.avatar)}}" alt="avatar de {{user.nickname}}" class="img-fluid"/>
                            </div>
                                <h2><a href="{{path('account_profile', {'nickname': user.nickname })}}">{{user.nickname}}</a> </h2>
                        </div>
                        <div>
                            <span class="mx-2">
                            {{article.views}}{{article.views <= 1 ? ' vue':' vues'}} • {{article.createdAt|date('d-m-Y')}}
                            </span>

                            <button type="button" class="btn" id="like-article" data-id='{{article.id}}'>
                            {% set isLiked = false %}
                                {# Si il y a des likes, on verifie dans ces likes si il y en a un qui a une correspondance avec l'user connecté #}
                                    {% if article.likes %}
                                        {% for like in article.likes %}
                                            {% if like.user == app.user %}
                                                {# si il y a une correspondance entre l'user connecté et le like dans la bdd, on met isLiked en true pour que le pouce soit activé #}
                                                {% set isLiked = true %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    {% if isLiked %} {# l'user aime déjà la vidéo #}
                                          <i class="fa-solid fa-thumbs-up fa-2x"></i>
                                    {% else %} {# l'user n'aime pas encore la vidéo #}
                                          <i class="fa-regular fa-thumbs-up fa-2x"></i>
                                    {% endif %}
                                    <span id="like_count">
                                        {{article.likes|length }}
                                    </span>
                            </button>
                        </div>
                    </div>
                    <div class="my-3 article-content-show">
                        <p class="pe-4">{{article.content|raw}}</p>    
                    </div>
                    
                    {# Espace commentaire #}
                    <div class="addCommentForm">
                        {{form_start(form)}}
                            {{form_widget(form)}}
                            <button type="submit" class="btn">Valider</button>
                        {{form_end(form)}}
                    </div>
                    <div>
                    {# pour chaque commentaire, affichage du contenu + auteur + possibilité de supprimer ses propres commentaires #}
                        {% for comment in article.comments %}
                        <div class="commentWrap">
                            <div class="commentAuthor">
                                <div>
                                    <img src="{{asset('uploads/avatar/'~ comment.author.avatar)}}" alt="avatar de {{comment.author.nickname}}">
                                    <a href="{{path('account_profile', {'nickname': comment.author.nickname })}}">{{comment.author.nickname}}</a>
                                    <span class="text-muted">
                                        • {{comment.createdAt|date('d-m-Y H:i')}}
                                    </span>
                                </div>
                                
                                {# Si le commentaire appartient à l'auteur, il peut le supprimer #}
                                {% if comment.author == app.user %}
                                    <a href="{{path('comment_delete', {'id': comment.id})}}" class="btn btn-danger btn-sm">X Supprimer</a>
                                {% endif %}
                            </div>
                                {{comment.content|raw}}
                        </div>
                        {% endfor %}
                    </div>

                    
                </div>
                <div class="col-md-4">
                {# articles du même auteur #}
                    <div class="row g-4" id="wrapSameAuthorArticle">
                    {% if articles|length > 0 %}
                        {% for article in articles %}
                             <div class="col-md-6">
                                <div class="card">
                                <div class="thumb-wrap">
                                    {% if article.video %}
                                        <img src="{{asset('uploads/article/video/thumb/'~ article.video.thumbnail)}}" class="card-img-top" alt="Vignette de l'article {{article.title}} de {{article.author}}">
                                    {% elseif article.images is not empty %}
                                            {% for image in article.images %}
                                                {% if loop.first %}
                                                    <img class="figure-img rounded" src="{{asset('/uploads/article/image/'~ image.source)}}" alt="Image d'illustration de l'article {{article.title}}" >
                                                {% endif %}
                                            {% endfor %}
                                    {% else %}
                                            <img class="figure-img rounded img-fluid" src="{{asset('/img/blogDefault.png')}}" alt="Image d'illustration par défaut" >
                                    {% endif %}
                                </div>
                                        <div class="card-body">
                                            <h5 class="card-title">{{article.title}}</h5>
                                            {% set articleContent = article.content|u.truncate(30, '...', false) %}
                                            <p class="card-text">{{articleContent|raw}}</p>
                                            <a href="{{path('article_show', {'slug':article.slug})}}" class="stretched-link"></a>
                                        </div>
                                    </div>
                                </div>  
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning text-center">{{article.author.nickname}} n'a pas encore posté de contenu supplémentaire.</div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </section>
    <script>
      {# detection format image #}
        let imgs = document.querySelectorAll("img");
        let img;

        for (i = 0 ; i < imgs.length; i++){
            img = imgs[i];
            if(img.complete){
                checkImage(img);
            } else {
                img.addEventListener("load", function(){
                    checkImage(this);
                })
            }

            function checkImage(image){
                if(image.naturalHeight > image.naturalWidth){
                    image.classList.add("portrait");
                     console.log('portrait');
                } else {
                    image.classList.add("landscape");
                     console.log('paysage');
                }
            }
        }
    </script>
{% endblock %}

{# PLYR #}
{% block stylesheets %}  
        <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
{% endblock %}

{% block javascripts %}
    <script>

        import Plyr from 'plyr';
        const player = new Plyr('#player');

        <script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>

    
  </script>  
{% endblock %}